<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket ç¾¤èŠ & ç§èŠ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #2C2F33;
            color: #FFF;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            width: 90vw;
            max-width: 800px;
            background: #36393F;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            height: 90vh;
        }
        h2 {
            text-align: center;
            color: #7289DA;
        }
        #chat {
            flex: 1;
            overflow-y: auto;
            background: #23272A;
            border-radius: 5px;
            padding: 10px;
        }
        .message {
            display: flex;
            margin: 5px 0;
            align-items: center;
        }
        .message-content {
            max-width: 70%;
            padding: 10px;
            border-radius: 10px;
            background: #40444B;
        }
        .message.user {
            justify-content: flex-end;
        }
        .message.user .message-content {
            background: #7289DA;
        }
        .message.private {
            background: #F39C12;
        }
        input, button, select {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            border: none;
            font-size: 14px;
        }
        input {
            background: #40444B;
            color: #FFF;
        }
        button {
            background: #7289DA;
            color: #FFF;
            cursor: pointer;
        }
        button:hover {
            background: #677BC4;
        }
    </style>
</head>
<body>
<div class="container">
    <h2>WebSocket èŠå¤©</h2>
    <input type="text" id="username" placeholder="è¾“å…¥æ˜µç§°...">
    <select id="room">
        <option value="å…¬å…±ç¾¤èŠ">å…¬å…±ç¾¤èŠ</option>
        <option value="æŠ€æœ¯äº¤æµ">æŠ€æœ¯äº¤æµ</option>
        <option value="ä¼‘é—²èŠå¤©">ä¼‘é—²èŠå¤©</option>
    </select>
    <button onclick="joinChat()">åŠ å…¥èŠå¤©</button>
    <div id="chat"></div>
    <input type="text" id="message" placeholder="è¾“å…¥æ¶ˆæ¯...">
    <select id="privateUser">
        <option value="">ç¾¤èŠ</option>
    </select>
    <button onclick="sendMessage()">å‘é€</button>
</div>

<script>
    let ws;
    let userName;
    let room;
    let users = [];

    function joinChat() {
        userName = document.getElementById("username").value;
        room = document.getElementById("room").value;
        if (!userName) {
            alert("è¯·è¾“å…¥æ˜µç§°");
            return;
        }

        ws = new WebSocket("ws://localhost:3000");
        ws.onopen = () => {
            ws.send(JSON.stringify({ type: 'join', user: userName, room: room }));
            let chatBox = document.getElementById("chat");
            chatBox.innerHTML += `<p style='color:#43B581;'>âœ… æ¬¢è¿ ${userName} åŠ å…¥ ${room}ï¼</p>`;
        };
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'userList') {
                users = data.users;
                updateUserList();
            } else if (data.type === 'message' && data.data.user && data.data.message) {
                let chatBox = document.getElementById("chat");
                let messageClass = data.data.user === userName ? "user" : "";
                if (data.data.private) messageClass += " private";
                let privateTag = data.data.private ? "ğŸ”’ [ç§èŠ] " : "";
                chatBox.innerHTML += `<div class='message ${messageClass}'><div class='message-content'><b>${privateTag}${data.data.user}:</b> ${data.data.message}</div></div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        };
    }

    function sendMessage() {
        const input = document.getElementById("message");
        if (!input.value.trim()) return;
        const privateUser = document.getElementById("privateUser").value;
        const msg = {
            type: 'message',
            user: userName,
            message: input.value,
            room: room,
            private: privateUser ? true : false,
            to: privateUser || null
        };
        ws.send(JSON.stringify(msg));

        // è®©å‘é€æ–¹æœ¬äººä¹Ÿèƒ½ç«‹å³çœ‹åˆ°è‡ªå·±çš„ç§èŠæ¶ˆæ¯
        if (privateUser) {
            let chatBox = document.getElementById("chat");
            chatBox.innerHTML += `<div class='message user private'><div class='message-content'><b>ğŸ”’ [ç§èŠ] ${userName}:</b> ${input.value}</div></div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        input.value = "";
    }

    function updateUserList() {
        let privateUserSelect = document.getElementById("privateUser");
        privateUserSelect.innerHTML = '<option value="">ç¾¤èŠ</option>';
        users.forEach(user => {
            if (user !== userName) {
                privateUserSelect.innerHTML += `<option value="${user}">${user}</option>`;
            }
        });
    }
</script>
</body>
</html>
